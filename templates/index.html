<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººäººéƒ½æ˜¯äº§å“ç»ç† - AI ä¸“æ </title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' fill='url(%23grad)'/%3E%3Cpath d='M16 20 L32 28 L48 20 L48 44 L32 52 L16 44 Z' fill='white' opacity='0.9'/%3E%3Ccircle cx='32' cy='36' r='8' fill='%23f1c40f'/%3E%3Ctext x='32' y='40' font-family='Arial, sans-serif' font-size='12' font-weight='bold' text-anchor='middle' fill='white'%3EAI%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- è¯„åˆ†è¯¦æƒ…å¼¹çª— -->
    <div id="score-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“Š æ–‡ç« è¯„åˆ†è¯¦æƒ…</h2>
                <span class="close-btn" onclick="closeScoreModal()">&times;</span>
            </div>
            <div class="modal-body" id="score-details-content">
                <!-- è¯„åˆ†è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        </div>
    </div>

    <div class="container">
        <header>
            <h1>ğŸ“š äººäººéƒ½æ˜¯äº§å“ç»ç† - AI ä¸“æ </h1>
            <div class="stats">
                <span class="stat-item">æ€»è®¡: <strong id="total-count">0</strong></span>
                <span class="stat-item">å·²è¯»: <strong id="read-count">0</strong></span>
                <span class="stat-item">æœªè¯»: <strong id="unread-count">0</strong></span>
                <span class="stat-item">ä¸‹æ¬¡æ›´æ–°: <strong id="next-update">åŠ è½½ä¸­...</strong></span>
            </div>
            <div class="actions">
                <label class="checkbox-label">
                    <input type="checkbox" id="auto-score" checked>
                    <span>è‡ªåŠ¨è¯„ä»·æ–°å¢æ–‡ç« </span>
                </label>
                <div class="action-group">
                    <button class="update-btn" onclick="manualUpdate()">
                        ğŸ”„ ç«‹å³æ›´æ–°
                    </button>
                    <span class="action-desc">æŠ“å–å‰ 3 é¡µæœ€æ–°æ–‡ç« </span>
                </div>
                <div class="action-group">
                    <button class="update-btn catchup-btn" onclick="manualCatchup()">
                        ğŸ“¥ è¡¥é½å†å²æ•°æ®
                    </button>
                    <span class="action-desc">æŠ“å–å¤šé¡µå†å²æ–‡ç« ï¼ˆå¯è®¾ç½®æ—¥æœŸèŒƒå›´ï¼‰</span>
                </div>
            </div>
        </header>

        <div class="filters">
            <button class="filter-btn {{ 'active' if show_marked == 'all' else '' }}" onclick="filterArticles('all')">
                å…¨éƒ¨æ–‡ç« 
            </button>
            <button class="filter-btn {{ 'active' if show_marked == 'marked' else '' }}" onclick="filterArticles('marked')">
                â­ æ ‡è®°æ–‡ç« 
            </button>
        </div>

        <div class="articles-list">
            {% for article in articles %}
            <div class="article-card {{ 'marked' if article.read else 'unmarked' }}" id="article-{{ loop.index }}">
                <div class="article-header">
                    <input type="checkbox"
                           class="read-checkbox"
                           {{ 'checked' if article.read else '' }}
                           onchange="toggleRead('{{ article.link }}', this)">
                    <h2 class="article-title">
                        <a href="{{ article.link }}" target="_blank">
                            {{ article.title }}
                        </a>
                    </h2>
                </div>
                <div class="article-meta">
                    <span class="meta-item">ğŸ“… {{ article.time }}</span>
                    <span class="meta-item">ğŸ“ {{ article.length }} å­—</span>
                    {% if article.score %}
                    <span class="meta-item score-display">ğŸ¯ è¯„åˆ†: <strong>{{ article.score }}</strong>/5</span>
                    {% endif %}
                </div>
                <div class="article-desc">{{ article.desc }}</div>
                <div class="article-note" id="note-display-{{ loop.index }}">
                    <!-- ç¬”è®°å†…å®¹å°†é€šè¿‡ JavaScript åŠ è½½ -->
                </div>
                <div class="article-note-editor" id="note-editor-{{ loop.index }}" style="display: none;">
                    <textarea 
                        class="note-textarea" 
                        id="note-textarea-{{ loop.index }}" 
                        placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„é˜…è¯»ç¬”è®°..."
                        rows="4"
                    ></textarea>
                    <div class="note-actions">
                        <button class="note-btn save-note-btn" onclick="saveNote('{{ article.link }}', {{ loop.index }})">
                            ğŸ’¾ ä¿å­˜ç¬”è®°
                        </button>
                        <button class="note-btn cancel-note-btn" onclick="cancelNote({{ loop.index }})">
                            âŒ å–æ¶ˆ
                        </button>
                        <button class="note-btn delete-note-btn" onclick="deleteNote('{{ article.link }}', {{ loop.index }})" style="display: none;">
                            ğŸ—‘ï¸ åˆ é™¤ç¬”è®°
                        </button>
                    </div>
                </div>
                <div class="article-actions">
                    <button class="note-btn toggle-note-btn" onclick="toggleNoteEditor('{{ article.link }}', {{ loop.index }})">
                        ğŸ“ ç¬”è®°
                    </button>
                    {% if article.score %}
                    <button class="score-btn" onclick="showScoreDetails('{{ article.link }}')">
                        æŸ¥çœ‹è¯„åˆ†è¯¦æƒ…
                    </button>
                    <button class="score-btn re-score-btn" onclick="evaluateArticle('{{ article.link }}', '{{ article.title }}')">
                        ğŸ”„ é‡æ–°è¯„åˆ†
                    </button>
                    {% else %}
                    <button class="score-btn" onclick="evaluateArticle('{{ article.link }}', '{{ article.title }}')">
                        AI è¯„åˆ†
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- åˆ†é¡µ -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% if current_page > 1 %}
            <button class="page-btn" onclick="goToPage({{ current_page - 1 }})">
                ä¸Šä¸€é¡µ
            </button>
            {% endif %}

            <div class="page-numbers">
                {% for page_num in page_range %}
                    {% if page_num == current_page %}
                    <button class="page-btn active">{{ page_num }}</button>
                    {% elif page_num == '...' %}
                    <span class="page-ellipsis">...</span>
                    {% else %}
                    <button class="page-btn" onclick="goToPage({{ page_num }})">{{ page_num }}</button>
                    {% endif %}
                {% endfor %}
            </div>

            {% if current_page < total_pages %}
            <button class="page-btn" onclick="goToPage({{ current_page + 1 }})">
                ä¸‹ä¸€é¡µ
            </button>
            {% endif %}

            <div class="page-info">
                ç¬¬ {{ current_page }} / {{ total_pages }} é¡µ
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStats() {
            fetch('/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-count').textContent = data.total;
                    document.getElementById('read-count').textContent = data.read;
                    document.getElementById('unread-count').textContent = data.unread;
                });
        }

        // åŠ è½½æœåŠ¡çŠ¶æ€
        function loadStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    if (data.next_update) {
                        document.getElementById('next-update').textContent = data.next_update;
                    } else {
                        document.getElementById('next-update').textContent = 'æœªè®¾ç½®';
                    }
                });
        }

// æ‰‹åŠ¨æ›´æ–°
function manualUpdate() {
    if (!confirm('ç¡®å®šè¦ç«‹å³æ›´æ–°æ–‡ç« æ•°æ®å—ï¼Ÿ')) {
        return;
    }

    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'â³ æ›´æ–°ä¸­...';

    const autoScore = document.getElementById('auto-score').checked;

    fetch('/update_now', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            auto_score: autoScore
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // è½®è¯¢æ£€æŸ¥æ›´æ–°æ˜¯å¦å®Œæˆ
            let checkCount = 0;
            const maxChecks = 60; // æœ€å¤šæ£€æŸ¥ 60 æ¬¡ï¼ˆçº¦ 2 åˆ†é’Ÿï¼‰
            const checkInterval = setInterval(() => {
                checkCount++;
                fetch('/stats')
                    .then(response => response.json())
                    .then(stats => {
                        // æ˜¾ç¤ºæ›´æ–°è¿›åº¦
                        btn.textContent = `â³ æ›´æ–°ä¸­... (${checkCount * 2}s)`;

                        // å¦‚æœæ£€æŸ¥æ¬¡æ•°è¶…è¿‡é™åˆ¶ï¼Œåœæ­¢è½®è¯¢å¹¶åˆ·æ–°
                        if (checkCount >= maxChecks) {
                            clearInterval(checkInterval);
                            location.reload();
                        }
                    })
                    .catch(() => {
                        // å¦‚æœå‡ºé”™ï¼Œåœæ­¢è½®è¯¢å¹¶åˆ·æ–°
                        clearInterval(checkInterval);
                        location.reload();
                    });
            }, 2000); // æ¯ 2 ç§’æ£€æŸ¥ä¸€æ¬¡
        } else {
            alert('æ›´æ–°å¤±è´¥: ' + data.message);
            btn.disabled = false;
            btn.textContent = originalText;
        }
    })
    .catch(error => {
        alert('æ›´æ–°å¤±è´¥: ' + error);
        btn.disabled = false;
        btn.textContent = originalText;
    });
}

// è¡¥é½å†å²æ•°æ®
function manualCatchup() {
    const startDate = prompt('è¯·è¾“å…¥èµ·å§‹æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼Œä¾‹å¦‚ï¼š2025-12-01ï¼‰\nç•™ç©ºåˆ™ä¸é™åˆ¶æ—¥æœŸï¼ŒæŠ“å–æ‰€æœ‰å†å²æ–‡ç« ', '');
    const maxPages = prompt('è¯·è¾“å…¥æœ€å¤§æŠ“å–é¡µæ•°ï¼ˆé»˜è®¤ï¼š100ï¼‰', '100');

    if (maxPages === null) {
        return;
    }

    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'â³ è¡¥é½ä¸­...';

    const autoScore = document.getElementById('auto-score').checked;

    fetch('/catchup_data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            start_date: startDate || null,
            max_pages: parseInt(maxPages) || 100,
            mode: 0,
            auto_score: autoScore
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // è½®è¯¢æ£€æŸ¥æ›´æ–°æ˜¯å¦å®Œæˆ
            let checkCount = 0;
            const maxChecks = 300; // æœ€å¤šæ£€æŸ¥ 300 æ¬¡ï¼ˆçº¦ 10 åˆ†é’Ÿï¼Œè¡¥é½æ•°æ®å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
            const checkInterval = setInterval(() => {
                checkCount++;
                fetch('/stats')
                    .then(response => response.json())
                    .then(stats => {
                        // æ˜¾ç¤ºæ›´æ–°è¿›åº¦
                        btn.textContent = `â³ è¡¥é½ä¸­... (${checkCount * 2}s)`;

                        // å¦‚æœæ£€æŸ¥æ¬¡æ•°è¶…è¿‡é™åˆ¶ï¼Œåœæ­¢è½®è¯¢å¹¶åˆ·æ–°
                        if (checkCount >= maxChecks) {
                            clearInterval(checkInterval);
                            alert('è¡¥é½å·²å®Œæˆï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...');
                            location.reload();
                        }
                    })
                    .catch(() => {
                        // å¦‚æœå‡ºé”™ï¼Œåœæ­¢è½®è¯¢å¹¶åˆ·æ–°
                        clearInterval(checkInterval);
                        location.reload();
                    });
            }, 2000); // æ¯ 2 ç§’æ£€æŸ¥ä¸€æ¬¡
        } else {
            alert('è¡¥é½å¤±è´¥: ' + data.message);
            btn.disabled = false;
            btn.textContent = originalText;
        }
    })
    .catch(error => {
        alert('è¡¥é½å¤±è´¥: ' + error);
        btn.disabled = false;
        btn.textContent = originalText;
    });
}

        // åˆ‡æ¢å·²è¯»çŠ¶æ€
        function toggleRead(link, checkbox) {
            const readStatus = checkbox.checked ? 1 : 0;

            fetch('/toggle_read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    link: link,
                    read: readStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadStats();
                    // æ›´æ–°å¡ç‰‡æ ·å¼
                    const articleCard = checkbox.closest('.article-card');
                    if (readStatus) {
                        articleCard.classList.remove('unmarked');
                        articleCard.classList.add('marked');
                    } else {
                        articleCard.classList.remove('marked');
                        articleCard.classList.add('unmarked');
                    }
                }
            });
        }

        // ç­›é€‰æ–‡ç« 
        function filterArticles(filter) {
            const url = new URL(window.location);
            url.searchParams.set('show_marked', filter);
            url.searchParams.set('page', '1');  // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            window.location.href = url.toString();
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function goToPage(pageNum) {
            const url = new URL(window.location);
            url.searchParams.set('page', pageNum);
            window.location.href = url.toString();
        }

        // AI è¯„åˆ†
        function evaluateArticle(link, title) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'â³ è¯„åˆ†ä¸­...';

            fetch('/evaluate_article', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    link: link,
                    title: title
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æå–æ€»åˆ†å’Œè¯„ä»·ï¼Œæ”¯æŒåµŒå¥—ç»“æ„
                    let overallScore = 0;
                    let summary = '';
                    const result = data.result;

                    if (result.overall_score) {
                        overallScore = result.overall_score;
                        summary = result.summary || '';
                    } else if (result['ç»¼åˆè¯„ä»·']) {
                        overallScore = result['ç»¼åˆè¯„ä»·'].overall_score;
                        summary = result['ç»¼åˆè¯„ä»·'].summary || '';
                    }

                    // è¯„åˆ†å®Œæˆï¼Œåˆ·æ–°é¡µé¢æ›´æ–°æŒ‰é’®çŠ¶æ€
                    location.reload();
                } else {
                    alert('è¯„åˆ†å¤±è´¥: ' + data.message);
                    btn.disabled = false;
                    btn.textContent = 'AI è¯„åˆ†';
                }
            })
            .catch(error => {
                alert('è¯„åˆ†å¤±è´¥: ' + error);
                btn.disabled = false;
                btn.textContent = 'AI è¯„åˆ†';
            });
        }

        // æ˜¾ç¤ºè¯„åˆ†è¯¦æƒ…
        function showScoreDetails(link) {
            // ä»æ•°æ®åº“è·å–è¯„åˆ†è¯¦æƒ…
            fetch(`/article_score?link=${encodeURIComponent(link)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.score_details) {
                        const details = JSON.parse(data.score_details);
                        let overallScore = 0;
                        let summary = '';

                        // æå–æ€»åˆ†å’Œè¯„ä»·ï¼Œæ”¯æŒåµŒå¥—ç»“æ„
                        if (details.overall_score) {
                            overallScore = details.overall_score;
                            summary = details.summary || '';
                        } else if (details['ç»¼åˆè¯„ä»·']) {
                            overallScore = details['ç»¼åˆè¯„ä»·'].overall_score;
                            summary = details['ç»¼åˆè¯„ä»·'].summary || '';
                        }

                        // æ„å»ºè¯„åˆ†è¯¦æƒ… HTML
                        let detailsHtml = `
                            <div class="score-overview">
                                <div class="score-circle">
                                    <span class="score-number">${overallScore}</span>
                                    <span class="score-label">æ€»åˆ†</span>
                                </div>
                                <div class="score-summary">
                                    <h3>ç»¼åˆè¯„ä»·</h3>
                                    <p>${summary || 'æš‚æ— è¯„ä»·'}</p>
                                </div>
                            </div>
                            <div class="score-dimensions">
                                <h3>å„ç»´åº¦å¾—åˆ†</h3>
                        `;

                        // æ·»åŠ æ–‡ç« æ¦‚è¿°
                        if (details['æ–‡ç« æ¦‚è¿°']) {
                            detailsHtml += `
                                <div class="dimension-item article-summary">
                                    <div class="dimension-header">
                                        <span class="dimension-name">ğŸ“ æ–‡ç« æ¦‚è¿°</span>
                                    </div>
                                    <div class="dimension-comment">${details['æ–‡ç« æ¦‚è¿°']}</div>
                                </div>
                            `;
                        }

                        // éå†å„ç»´åº¦è¯„åˆ†
                        for (const [dimension, info] of Object.entries(details)) {
                            if (dimension === 'ç»¼åˆè¯„ä»·') continue;

                            if (typeof info === 'object' && info !== null) {
                                const score = info.score;
                                const comment = info.comment || '';
                                if (score !== undefined) {
                                    detailsHtml += `
                                        <div class="dimension-item">
                                            <div class="dimension-header">
                                                <span class="dimension-name">${dimension}</span>
                                                <span class="dimension-score">${score}/5</span>
                                            </div>
                                            ${comment ? `<div class="dimension-comment">${comment}</div>` : ''}
                                        </div>
                                    `;
                                }
                            } else if (typeof info === 'number') {
                                detailsHtml += `
                                    <div class="dimension-item">
                                        <div class="dimension-header">
                                            <span class="dimension-name">${dimension}</span>
                                            <span class="dimension-score">${info}/5</span>
                                        </div>
                                    </div>
                                `;
                            }
                        }

                        detailsHtml += '</div>';

                        document.getElementById('score-details-content').innerHTML = detailsHtml;
                        document.getElementById('score-modal').style.display = 'block';
                    } else {
                        alert('æ— æ³•è·å–è¯„åˆ†è¯¦æƒ…');
                    }
                })
                .catch(error => {
                    alert('è·å–è¯„åˆ†è¯¦æƒ…å¤±è´¥: ' + error);
                });
        }

        // å…³é—­è¯„åˆ†è¯¦æƒ…å¼¹çª—
        function closeScoreModal() {
            document.getElementById('score-modal').style.display = 'none';
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('score-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // åŠ è½½æ–‡ç« ç¬”è®°
        function loadNote(link, index) {
            fetch(`/get_note?link=${encodeURIComponent(link)}`)
                .then(response => response.json())
                .then(data => {
                    const noteDisplay = document.getElementById(`note-display-${index}`);
                    const noteEditor = document.getElementById(`note-editor-${index}`);
                    const noteTextarea = document.getElementById(`note-textarea-${index}`);
                    const deleteBtn = noteEditor.querySelector('.delete-note-btn');
                    
                    if (data.success && data.note) {
                        // æ˜¾ç¤ºç¬”è®°å†…å®¹
                        noteDisplay.innerHTML = `
                            <div class="note-content">
                                <div class="note-header">
                                    <span class="note-label">ğŸ“ æˆ‘çš„ç¬”è®°</span>
                                    <span class="note-time">æ›´æ–°äº ${formatTime(data.note.updated_at)}</span>
                                </div>
                                <div class="note-text">${escapeHtml(data.note.content)}</div>
                            </div>
                        `;
                        noteDisplay.style.display = 'block';
                        noteTextarea.value = data.note.content;
                        deleteBtn.style.display = 'block';
                    } else {
                        noteDisplay.innerHTML = '';
                        noteDisplay.style.display = 'none';
                        noteTextarea.value = '';
                        deleteBtn.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
                });
        }

        // åˆ‡æ¢ç¬”è®°ç¼–è¾‘å™¨
        function toggleNoteEditor(link, index) {
            const noteDisplay = document.getElementById(`note-display-${index}`);
            const noteEditor = document.getElementById(`note-editor-${index}`);
            
            if (noteEditor.style.display === 'none') {
                // æ˜¾ç¤ºç¼–è¾‘å™¨
                noteEditor.style.display = 'block';
                noteDisplay.style.display = 'none';
                // åŠ è½½ç¬”è®°å†…å®¹
                loadNote(link, index);
            } else {
                // éšè—ç¼–è¾‘å™¨
                noteEditor.style.display = 'none';
                noteDisplay.style.display = 'block';
                // é‡æ–°åŠ è½½ç¬”è®°æ˜¾ç¤º
                loadNote(link, index);
            }
        }

        // ä¿å­˜ç¬”è®°
        function saveNote(link, index) {
            const noteTextarea = document.getElementById(`note-textarea-${index}`);
            const content = noteTextarea.value.trim();
            const btn = event.target;
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.textContent = 'â³ ä¿å­˜ä¸­...';

            fetch('/save_note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    link: link,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // é‡æ–°åŠ è½½ç¬”è®°æ˜¾ç¤º
                    loadNote(link, index);
                    // éšè—ç¼–è¾‘å™¨
                    document.getElementById(`note-editor-${index}`).style.display = 'none';
                    document.getElementById(`note-display-${index}`).style.display = 'block';
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.message);
                }
                btn.disabled = false;
                btn.textContent = originalText;
            })
            .catch(error => {
                alert('ä¿å­˜å¤±è´¥: ' + error);
                btn.disabled = false;
                btn.textContent = originalText;
            });
        }

        // å–æ¶ˆç¼–è¾‘ç¬”è®°
        function cancelNote(index) {
            // éšè—ç¼–è¾‘å™¨
            document.getElementById(`note-editor-${index}`).style.display = 'none';
            document.getElementById(`note-display-${index}`).style.display = 'block';
        }

        // åˆ é™¤ç¬”è®°
        function deleteNote(link, index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) {
                return;
            }

            fetch('/delete_note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    link: link
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // é‡æ–°åŠ è½½ç¬”è®°æ˜¾ç¤º
                    loadNote(link, index);
                    // éšè—ç¼–è¾‘å™¨
                    document.getElementById(`note-editor-${index}`).style.display = 'none';
                    document.getElementById(`note-display-${index}`).style.display = 'block';
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                alert('åˆ é™¤å¤±è´¥: ' + error);
            });
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            if (!timeStr) return '';
            const date = new Date(timeStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡æ•°æ®å’ŒæœåŠ¡çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadStatus();
            
            // åŠ è½½æ‰€æœ‰æ–‡ç« çš„ç¬”è®°
            const articleCards = document.querySelectorAll('.article-card');
            articleCards.forEach((card, index) => {
                const link = card.querySelector('.article-title a').href;
                loadNote(link, index + 1);
            });
        });
    </script>
</body>
</html>